# Contouring Quest

PySide6 ベースの医用画像コンツーリング教育アプリケーションです。
CT 画像上で ROI（関心領域）を描画し、正解データとの比較でスコアリングを行います。

> **対応 OS:** Windows 11

---

## ディレクトリ構成

```
Contouring_Quest/
├── app/                         … アプリケーション本体
│   ├── __main__.py              … エントリポイント
│   ├── common/                  … 共通ユーティリティ
│   ├── contouring/              … コンツーリング機能
│   ├── hub/                     … メイン画面
│   ├── leaderboard/             … リーダーボード
│   ├── review/                  … おさらい画面
│   └── scoring/                 … スコアリング
├── contour_quest_config.json    … 設定ファイル
├── nifti/                       … CT・正解ラベル（NIfTI 形式）
├── records/                     … 実行結果の出力先
│   └── csv/                     … スコア CSV
├── LICENSES/                    … ライセンス全文
├── NOTICES/                     … サードパーティ通知
├── requirements.txt             … pip 依存パッケージ一覧
├── 0_install.bat                … tar.gz 展開用インストーラー
└── run.bat                      … アプリ起動スクリプト
```

---

## インストール方法

配布された zip ファイルを任意のフォルダに展開し、`0_install.bat` をダブルクリックしてください。

このスクリプトが行うこと:
- `app_env.tar.gz` を `app_env/` に展開（3〜10 分程度）
- `conda-unpack` でパスを修正
- `records/` と `nifti/` ディレクトリの作成
- デスクトップショートカットの作成

> PC のシステムには何もインストールされません。フォルダ内に展開するのみです。

### 起動

以下のいずれかで起動します:
- デスクトップの **Contouring Quest** ショートカット
- `run.bat` をダブルクリック

> **補足:** Python 環境をお持ちの方は、`pip install -r requirements.txt` でパッケージを導入し `python -m app` で直接起動することもできます。

---

## 初回セットアップ（CT データと正解ラベルの準備）

このアプリには NIfTI データ（CT 画像・正解ラベル）は含まれていません。
初回起動時に、以下の手順で自分の CT データを登録し、正解ラベルを作成してください。

### 1. CT 画像を用意する

NIfTI 形式（`.nii.gz`）の CT 画像を `nifti/` フォルダに配置します。

### 2. 設定画面を開く

1. アプリを起動します（`run.bat` またはデスクトップショートカット）
2. ハブ画面の右上にある **「設定」** ボタンをクリック
3. パスワード `kochi` を入力

### 3. 部位セットを登録する

設定画面が開きます。初期状態では「使用例（削除してください）」というサンプルが入っています。

1. **「＋追加」** をクリックして新しい部位セット名を入力（例: `腹部`）
2. **ROI（カンマ区切り）** に描画する臓器名を入力（例: `右腎,胃,胆嚢`）
3. **制限時間** を設定（本番モードで使用）
4. **CT NIfTI** の「参照…」から、手順 1 で用意した `.nii.gz` を選択
5. サンプルの「使用例（削除してください）」は **「削除」** ボタンで消してください

### 4. 正解ラベルを作成する

CT を登録したら、その CT 上で正解となるコンツーリングを作成します。

1. 設定画面の **正解ラベル NIfTI** の横にある **「作成/編集」** ボタンをクリック
2. コンツーリング画面が開き、指定した ROI の描画モードになります
3. CT 画像上で各 ROI の正解となる輪郭を描画します
4. 描画が完了したら **Save** で保存します
5. 設定画面に戻ると、正解ラベルのパスが自動で入力されています

### 5. 設定を保存する

設定画面の **「Save」** をクリックして保存します。
これで部位セットの登録が完了し、参加者がプレイできる状態になります。

---

## 使い方

### コンツーリング（プレイ）

1. アプリを起動するとハブ画面が表示されます
2. 班名・チーム名・ID を入力し、対象部位を選択します
3. **「プレイ」** で本番開始（制限時間あり）、**「練習」** で時間無制限の練習ができます
4. CT 画像上で ROI を描画し、制限時間内に完了してください
5. 終了後、自動でスコアリング画面が表示されます

### 結果の確認（リーダーボード）

全員の結果を確認するには、各参加者の `records/` フォルダを 1 か所に集めてから
リーダーボード画面を開きます。

### おさらい（レビュー）

レビュー画面で自分や他の参加者の描画結果を正解と重ねて確認できます。
CSV と NIfTI の両方が必要です。

---

## 結果データ

実行結果は `records/` フォルダに保存されます:

```
records/
├── csv/              … スコア CSV ファイル
└── Group_X/          … 描画した ROI（NIfTI）と詳細 JSON
```

---

## ライセンス

本アプリケーションのソースコードは **MIT License** で公開されています。詳細は [LICENSE](LICENSE) を参照してください。

### 使用ライブラリ

| ライブラリ | ライセンス |
|-----------|-----------|
| PySide6 / Qt for Python | LGPL-3.0 |
| NumPy | BSD-3-Clause |
| nibabel | MIT |
| SciPy | BSD-3-Clause |
| scikit-image | BSD-3-Clause |

- 各ライブラリのライセンス全文は `LICENSES/` フォルダに同梱されています
- PySide6 の LGPL 準拠情報は `NOTICES/Qt-For-Python-NOTICE.txt` を参照してください
- PySide6 は動的リンクで使用しており、DLL の差し替えが可能です（LGPL-3.0 §4(d)-(e)）
